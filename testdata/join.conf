%include "ldap.conf"

Datenquellen(

  Datenquelle(
    NAME "MitarbeiterDieNichtImLDAPStehen"
    TYPE "thingy"
    SUBTYPE "ordered"
    URL "phantome.conf"
    Schluessel("Vorname" "Nachname" "Rolle")
  )
  
  Datenquelle(
    NAME "Personal"
    TYPE "union"
    SOURCE1 "MitarbeiterDieNichtImLDAPStehen"
    SOURCE2 "ldap"
      # TYPE "union" funktioniert nur, wenn der Schlüssel von
      # SOURCE1 vollständig im Schlüssel von SOURCE2 enthalten ist
      # oder umgekehrt
  )

  Datenquelle(
    NAME "LDAPFixes"
    TYPE "thingy"
    URL "ldapfixes.conf"
    Schluessel("Vorname" "Nachname" "OrgaKurz")
  )
  
  Datenquelle(
    NAME "ldap_gefixt"
    TYPE "override"
    SOURCE "ldap"
    WITH "LDAPfixes"
    MATCH("Vorname" "Vorname")
    MATCH("Nachname" "Nachname")
    MATCH("OrgaKurz" "OrgaKurz")
    OVERRIDE("Nachname" "Telefon" )
  )

  Datenquelle( 
    NAME "verkehrsverbindungen"
    TYPE "thingy"
    SUBTYPE "ordered"
    URL "verkehrsverbindungen.conf"
    Schluessel("Adresse")
  )


  Datenquelle(
    NAME "PersonalMitVerkehrsverbindungen"

    TYPE "add"
    
    SOURCE "ldap"
    ADD "verkehrsverbindungen"
    MATCH ("Dienstgebaeude" "Adresse")
    
      # Zur Erstellung der Menge der Ergebnisdatensätze
      # wird jeder Datensatz aus SOURCE1 genau einmal verwendet und 
      # jeder Datensatz aus SOURCE2 beliebig oft (auch keinmal).
      # Dies verhindert
      #  a) dass eine Person 2 mal auftaucht, nur weil es 2 Einträge
      #     mit Verkehrsverbindungen für ihre Adresse gibt
      #  b) dass eine Person rausfliegt, weil es zu ihrer Adresse keine
      #     Verkehrsverbindung gibt
      # Als Schlüsselattribute werden
      # nur die Attribute von SOURCE1 und nicht zusätzlich die von SOURCE2
      # verwendet werden, wodurch verhindert wird, 
      # dass ein Datensatz bei einer Änderung der Adresse aus der lokalen
      # Absenderliste fliegt, weil er beim Cache-Refresh nicht mehr
      # gefunden wird.
      #
      # In der Ergebnisdatenquelle sind alle Spalten von SOURCE1 unter
      # ihrem ursprünglichen Namen, alle Spalten von SOURCE2 unter dem
      # Namen von SOURCE2 konkateniert mit "." konkateniert mit dem
      # Spaltennamen zu finden.
  )


  
  Datenquelle(
    NAME "Personal"
    TYPE "rename"
    SOURCE "PersonalMitVerkehrsverbindungen"
    Spalten(
      ("verkehrsverbindungen.OPNV1" "OPNV1")
      ("verkehrsverbindungen.OPNV2" "OPNV2")
      ("verkehrsverbindungen.OPNV3" "OPNV3")
      ("verkehrsverbindungen.OPNV4" "OPNV4")
    )
  )
  
)
